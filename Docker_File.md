# KTB 클라우드 과정 필기 노트 / 7월 10일 (8일차) - Dockerfile



## Dockerfile
- 이미지를 생성하기 위한 용도로 작성되는 파일
- 특징
    - 환경 일관성
        - Dockerfile을 사용하면 개발 환경, 테스트 환경, 배포 환경 등 모든 환경에서 동일한 설정 유지
    - 이식성 
        - Docker 이미지는 다양한 운영체제에서 동일하게 동작
        - Dockerfile로 만든 이미지는 어디서든 실행될 수 있음
    - 자동화
        - 애플리케이션의 빌드 및 배포 과정을 자동화
        - CI/CD 파이프라인 과정에서 빌드와 배포를 자동화하여 사용할 수 있음
    - 반복 가능성
        - 항상 동일한 방식으로 이미지를 빌드하기 때문에, 반복 가능한 환경을 제공 -> 디버깅과 테스트를 용이하게 관리
    - 확장성
        - 애플리케이션을 마이크로 아키텍처로 쉽게 확장


## Dockerfile 만들기

1. 이미지 크기 최적화
    - 멀티 스테이지 빌드 사용 : 불필요한 빌드 종속성 제거하여 최종 이미지 크기 줄임
    - 불필요한 파일 제외 : .dockerignore 파일을 사용하여 빌드에 포함되지 않아도 되는 파일을 제외
    - 불필요한 패키지 설치 X

2. 레이어 캐싱 활용
    - 변경이 적은 레이어 위에 변경이 잦은 레이어 위치 : 자주 변경되는 파일보다 덜 변경되는 파일을 먼저 추가하여 빌드 캐시를 최대한 활용

3. 보안 고려
    - 최소 권한 원칙
        - USER 지시자를 사용하여 루트 권한이 아닌 사용자로 애플리케이션을 실행
        ```
        USER appuser
        ```
        - 최신 베이스 이미지 사용
            - 최신 버전의 베이스 이미지를 사용하여 보안 패치가 적용된 상태를 유지
        - 비밀 정보 제외
            - 환경 변수나 소스 코드에 비밀 정보를 포함하지 않도록 주의

4. 성능 최적화
    - 적절한 베이스 이미지 선택
        - 필요에 맞는 가장 작은 베이스 이미지를 선택한다. 예를 들어, alpine 이미지는 매우 작음
        ```
        FROM alpine:latest
        ```
        - 의존성 최소화
            - 필요한 최소한의 라이브러리와 도구만 설치
            - python을 사용하는데, ubuntu 등 큰 이미지 사용하지 않기

5. 유지 관리 용이성
    - 명확하고 일관된 Dockerfile 작성 : 주석을 추가하여 각 지시자의 목적을 설명하고, 코드 스타일을 일관되게 유지
    ```Dockerfile
    # 베이스 이미지 설정
    FROM node:14

    # 작업 디렉토리 설정
    WORKDIR /app

    # 의존성 설치
    COPY package*json ./
    RUN npm install

    # 애플리케이션 소스 코드 복사
    COPY..

    # 컨테이너 시작 명령어
    CMD ["npm", "start"]
    ```

6. 환경 변수 사용
    - 동일한 Dockerfile로 다양한 환경 지원 : ENV 지시자나 ARG 지시자를 사용하여 환경 변수를 설정
    ```
    ARG NODE_ENV=production
    ENV NODE_ENV $NODE_ENV
    ```

## Dockerfile 깊게 보기
- MultiStage Build
    - 빌드 캐시 활용
        - Docker는 각 단계의 결과를 캐시하고, 빌드 된 단계가 있으면 Docker 결과를 재사용
    - 빌드 컨텍스트 최소화
        - COPY.. 명령어는 빌드 컨텍스트의 모든 파일을 복사
            - .dockerignore 파일을 사용하여 불필요한 파일을 제외
            ```
            # .dockerignore
            __pycache__
            *.pyc
            .gin
            ```
    - COPY --from=builder /app/myapp. 명령어는 builder 단계에서 생성된 파일만을 최종 이미지에 복사
        - 최종 이미지에는 필요하지 않은 파일이 포함되지 않도록 함


## Docker hub
- 도커에서 제공하는 이미지 호스팅 서비스
    - 개인이 이미지를 만들어서 배포 가능
    - 공식 저장소의 소프트웨어 및 애플리케이션을 포함
        - NGINX, Ubuntu, Mysql

- Docker Local Registry
    - Private Registry를 사용하기 위해 로컬 환경에서 관리 및 사용


## 실습









